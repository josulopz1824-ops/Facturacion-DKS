<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="global-styles.css">
    <title>Panel de Cobro | DKS-Hardware</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --dorado: #d4af37; --bg: #050505; --card: #121212; --danger: #ff4444; --success: #00c851; --warning: #ff8c00; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; padding: 40px; margin: 0; }
        
        .btn-home {
            position: fixed; top: 20px; left: 20px; background: #121212; color: #d4af37;
            text-decoration: none; padding: 10px 15px; border-radius: 8px; border: 1px solid #d4af37;
            display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 0.9rem;
            transition: 0.3s; z-index: 9999; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .btn-home:hover { background: #d4af37; color: black; transform: scale(1.05); }

        h1 { border-bottom: 2px solid var(--dorado); padding-bottom: 10px; margin-top: 40px; }
        
        .grid-deudores { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-top: 30px; }
        
        .card-deuda { 
            background: var(--card); padding: 20px; border-radius: 12px; 
            border: 1px solid #222; display: flex; flex-direction: column;
            justify-content: space-between; transition: 0.3s;
        }

        .cliente-info h2 { margin: 0; color: var(--dorado); font-size: 1.4rem; }
        .productos-lista { color: #888; font-size: 0.9rem; margin: 10px 0; }
        .monto-total { font-size: 1.8rem; font-weight: bold; margin: 10px 0; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn-cobrar { background: var(--success); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; flex: 1; transition: 0.3s; }
        .btn-abonar { background: var(--warning); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; flex: 1; transition: 0.3s; }
        .btn-cobrar:hover, .btn-abonar:hover { transform: translateY(-2px); filter: brightness(1.1); }
        
        .swal2-popup { background: #121212 !important; color: white !important; border: 1px solid var(--dorado) !important; }
    </style>
</head>
<body>

    <a href="index.html" class="btn-home"><span>DASHBOARD</span></a>

    <h1>Cuentas por Cobrar: <span id="nombreEmpresaLabel" style="color:var(--dorado)">...</span></h1>
    <p>Lista de clientes con saldo pendiente de la empresa.</p>

    <div class="grid-deudores" id="contenedorDeudores"></div>

    <script type="module">
        import { db, auth, verificarPermisos } from './auth-facturacion.js';
        import { collection, query, where, onSnapshot, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let empresaActual = "";

        // --- SEGURIDAD Y FILTRO POR EMPRESA ---
        async function iniciarDeudores() {
            const userData = await verificarPermisos();
            if (userData) {
                empresaActual = userData.empresa;
                document.getElementById('nombreEmpresaLabel').innerText = userData.nombreLocal || "Mi Empresa";
                inicializarEscuchaDeudas(empresaActual);
            }
        }

        iniciarDeudores();

        function inicializarEscuchaDeudas(empID) {
            // Filtramos por EMPRESA para que el Admin vea todos los fiados de su negocio
            const q = query(collection(db, "deudas"), where("empresa", "==", empID));

            onSnapshot(q, (snapshot) => {
                const contenedor = document.getElementById('contenedorDeudores');
                contenedor.innerHTML = ""; 
                let hayPendientes = false;

                snapshot.forEach((documento) => {
                    const data = documento.data();
                    const id = documento.id;

                    if (data.estado !== "pagado") {
                        hayPendientes = true;
                        const colorBorde = data.estado === "abonado" ? "var(--warning)" : "var(--danger)";
                        const etiquetaAbono = data.estado === "abonado" ? `<span style="color:var(--warning); font-size:0.8rem;"> (CON ABONOS)</span>` : "";

                        contenedor.innerHTML += `
                            <div class="card-deuda" style="border-left: 5px solid ${colorBorde}">
                                <div class="cliente-info">
                                    <h2>${data.cliente}${etiquetaAbono}</h2>
                                    <div class="productos-lista">
                                        <b>Artículos:</b> ${data.productos.join(", ")}
                                    </div>
                                </div>
                                <div>
                                    <div class="monto-total">L. ${data.total.toFixed(2)}</div>
                                    <div class="btn-group">
                                        <button class="btn-abonar" onclick="abonarDeuda('${id}', '${data.cliente}', ${data.total})">
                                            ABONAR
                                        </button>
                                        <button class="btn-cobrar" onclick="liquidarDeuda('${id}', '${data.cliente}')">
                                            SALDAR TOTAL
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });

                if (!hayPendientes) {
                    contenedor.innerHTML = "<p style='color:#555'>No hay cuentas pendientes en la empresa.</p>";
                }
            });
        }

        // --- FUNCIONES DE ACCIÓN ---

        window.abonarDeuda = async (id, nombre, totalActual) => {
            const { value: montoStr } = await Swal.fire({
                title: `Abono de ${nombre}`,
                input: 'number',
                inputLabel: `Saldo actual: L. ${totalActual.toFixed(2)}`,
                inputPlaceholder: 'Ingrese el monto a abonar',
                showCancelButton: true,
                confirmButtonColor: 'var(--warning)',
                inputValidator: (value) => {
                    if (!value || parseFloat(value) <= 0) return 'Ingrese un monto válido';
                    if (parseFloat(value) > totalActual) return 'El abono no puede ser mayor a la deuda';
                }
            });

            if (montoStr) {
                const monto = parseFloat(montoStr);
                try {
                    const docRef = doc(db, "deudas", id);
                    await updateDoc(docRef, {
                        total: totalActual - monto,
                        estado: "abonado",
                        ultimoAbono: monto,
                        fechaAbono: serverTimestamp()
                    });
                    Swal.fire('✅ ¡Abonado!', `Se restaron L. ${monto.toFixed(2)} de la cuenta.`, 'success');
                } catch (error) {
                    Swal.fire('Error', error.message, 'error');
                }
            }
        };

        window.liquidarDeuda = async (id, nombre) => {
            const result = await Swal.fire({
                title: '¿Saldar deuda completa?',
                text: `¿Confirmas que ${nombre} pagó el total de su cuenta?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: 'var(--success)',
                confirmButtonText: 'Sí, pagado'
            });

            if (result.isConfirmed) {
                try {
                    const docRef = doc(db, "deudas", id);
                    await updateDoc(docRef, {
                        estado: "pagado",
                        fechaPago: serverTimestamp()
                    });
                    Swal.fire('✅ Pagado', 'La cuenta ha sido cerrada.', 'success');
                } catch (error) {
                    Swal.fire('Error', error.message, 'error');
                }
            }
        };
    </script>
</body>
</html>