<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="global-styles.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Cloud | DKS-Hardware</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --dorado: #d4af37; --bg: #050505; --card: #121212; --danger: #ff4444; --success: #00c851; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; padding: 20px; margin: 0; }

        .btn-home {
            position: fixed; top: 20px; left: 20px; background: #121212; color: #d4af37;
            text-decoration: none; padding: 10px 15px; border-radius: 8px; border: 1px solid #d4af37;
            display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 0.9rem;
            transition: 0.3s; z-index: 9999; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .btn-home:hover { background: #d4af37; color: black; transform: scale(1.05); }

        .grid-layout { display: grid; grid-template-columns: 350px 1fr; gap: 20px; margin-top: 60px; }
        .editor-panel { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #222; height: fit-content; position: sticky; top: 20px; }
        .inventory-panel { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #222; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid var(--dorado); color: var(--dorado); font-size: 0.8rem; }
        td { padding: 12px; border-bottom: 1px solid #222; font-size: 0.9rem; }
        
        .low-stock { background: rgba(255, 68, 68, 0.1); }
        input, select { width: 100%; background: #000; border: 1px solid #333; color: white; padding: 10px; border-radius: 5px; margin-bottom: 10px; box-sizing: border-box; outline: none; }
        input:focus, select:focus { border-color: var(--dorado); }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 5px; }
        .btn-gold { background: var(--dorado); color: black; }
        .btn-success { background: var(--success); color: white; margin-top: 10px; }
        .btn-delete { background: none; border: 1px solid var(--danger); color: var(--danger); font-size: 0.7rem; width: auto; padding: 5px 10px; cursor: pointer; }
        .btn-edit { background: none; border: 1px solid var(--dorado); color: var(--dorado); font-size: 0.7rem; width: auto; padding: 5px 10px; margin-right: 5px; cursor: pointer; }

        .divider { border-top: 1px solid #333; margin: 25px 0; position: relative; }
        .divider span { position: absolute; top: -12px; left: 20px; background: var(--card); padding: 0 10px; color: #666; font-size: 0.7rem; font-weight: bold; }

        @media (max-width: 900px) { .grid-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <a href="index.html" class="btn-home"><span>DASHBOARD</span></a>

    <h1 style="margin-bottom: 10px; text-align: center;">DKS <span style="color:var(--dorado)">HARDWARE</span> CONTROL</h1>

    <div class="grid-layout">
        <div class="editor-panel">
            <h3 id="formTitle">Nuevo Producto</h3>
            <input type="hidden" id="prodId"> 
            <input type="text" id="nombre" placeholder="Nombre (ej. Tubo PVC)">
            <input type="text" id="categoria" placeholder="Categor칤a">
            <input type="number" id="stock" placeholder="Stock Inicial">
            <input type="number" id="min" placeholder="Stock M칤nimo">
            <input type="number" id="precio" placeholder="Precio Venta">
            
            <button class="btn btn-gold" id="btnGuardar">GUARDAR EN INVENTARIO</button>
            <button class="btn" id="btnCancelar" style="display:none; background:#333; color:white;">CANCELAR EDICI칍N</button>

            <div class="divider"><span>O CARGA R츼PIDA</span></div>

            <h3>游닍 Entrada de Stock</h3>
            <select id="selectProductoEntrada">
                <option value="">Seleccione producto...</option>
            </select>
            <input type="number" id="cantidadEntrada" placeholder="Cantidad a sumar">
            <button class="btn btn-success" id="btnSumarStock">A칌ADIR AL STOCK</button>
        </div>

        <div class="inventory-panel">
            <h3>Inventario de: <span id="nombreEmpresa" style="color:var(--dorado)">Cargando...</span></h3>
            <table>
                <thead>
                    <tr>
                        <th>PRODUCTO</th>
                        <th>CATEGOR칈A</th>
                        <th>STOCK</th>
                        <th>PRECIO</th>
                        <th>ACCIONES</th>
                    </tr>
                </thead>
                <tbody id="tablaDocs"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { auth, db, verificarPermisos } from './auth-facturacion.js';
        import { collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, serverTimestamp, query, where, increment } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let empresaActual = "";
        let productosLocal = []; // Para llenar el select de entrada r치pida

        async function iniciar() {
            const usuario = await verificarPermisos();
            if (usuario) {
                empresaActual = usuario.empresa;
                document.getElementById('nombreEmpresa').innerText = usuario.nombreLocal || empresaActual;
                cargarInventarioCompartido(empresaActual);
            }
        }

        iniciar();

        function cargarInventarioCompartido(empID) {
            const q = query(collection(db, "productos"), where("empresa", "==", empID));

            onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('tablaDocs');
                const selectEntrada = document.getElementById('selectProductoEntrada');
                
                tbody.innerHTML = "";
                selectEntrada.innerHTML = '<option value="">Seleccione producto...</option>';
                productosLocal = [];

                snapshot.forEach((d) => {
                    const p = d.data();
                    const isLow = p.stock <= p.min;
                    
                    // Llenar tabla
                    tbody.innerHTML += `
                        <tr class="${isLow ? 'low-stock' : ''}">
                            <td><b>${p.nombre}</b> ${isLow ? '丘멆잺' : ''}</td>
                            <td>${p.categoria}</td>
                            <td style="color: ${isLow ? 'var(--danger)' : 'var(--success)'}">${p.stock}</td>
                            <td>L. ${p.precio.toFixed(2)}</td>
                            <td>
                                <button onclick="prepararEdicion('${d.id}', '${p.nombre}', '${p.categoria}', ${p.stock}, ${p.min}, ${p.precio})" class="btn-edit">EDITAR</button>
                                <button onclick="eliminarProducto('${d.id}')" class="btn-delete">BORRAR</button>
                            </td>
                        </tr>
                    `;

                    // Llenar select de carga r치pida
                    selectEntrada.innerHTML += `<option value="${d.id}">${p.nombre} (Actual: ${p.stock})</option>`;
                });
            });
        }

        // --- GUARDAR O EDITAR ---
        document.getElementById('btnGuardar').onclick = async () => {
            const id = document.getElementById('prodId').value;
            const data = {
                nombre: document.getElementById('nombre').value,
                categoria: document.getElementById('categoria').value,
                stock: parseInt(document.getElementById('stock').value) || 0,
                min: parseInt(document.getElementById('min').value) || 0,
                precio: parseFloat(document.getElementById('precio').value) || 0,
                empresa: empresaActual,
                ultimaMod: serverTimestamp()
            };

            if(!data.nombre) return Swal.fire('Error', 'El nombre es obligatorio', 'error');

            try {
                if(id) {
                    await updateDoc(doc(db, "productos", id), data);
                    Swal.fire('Actualizado', 'Producto modificado con 칠xito', 'success');
                } else {
                    await addDoc(collection(db, "productos"), data);
                    Swal.fire('Guardado', 'Nuevo producto a침adido', 'success');
                }
                resetForm();
            } catch (e) {
                console.error(e);
            }
        };

        // --- ENTRADA R츼PIDA DE STOCK ---
        document.getElementById('btnSumarStock').onclick = async () => {
            const id = document.getElementById('selectProductoEntrada').value;
            const cantidad = parseInt(document.getElementById('cantidadEntrada').value);

            if(!id || isNaN(cantidad) || cantidad <= 0) {
                return Swal.fire('Atenci칩n', 'Seleccione un producto y una cantidad v치lida', 'warning');
            }

            try {
                const prodRef = doc(db, "productos", id);
                await updateDoc(prodRef, { stock: increment(cantidad) });
                
                // Registro de movimiento para el historial (Kardex)
                await addDoc(collection(db, "movimientos_inventario"), {
                    productoId: id,
                    tipo: "ENTRADA",
                    cantidad: cantidad,
                    fecha: serverTimestamp(),
                    empresa: empresaActual
                });

                Swal.fire('Stock Actualizado', `Se sumaron ${cantidad} unidades.`, 'success');
                document.getElementById('cantidadEntrada').value = "";
                document.getElementById('selectProductoEntrada').value = "";
            } catch (e) {
                Swal.fire('Error', e.message, 'error');
            }
        };

        // --- FUNCIONES GLOBALES ---
        window.eliminarProducto = async (id) => {
            const result = await Swal.fire({
                title: '쮼liminar producto?',
                text: "Esta acci칩n no se puede deshacer",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: 'var(--danger)',
                confirmButtonText: 'S칤, borrar'
            });

            if(result.isConfirmed) {
                await deleteDoc(doc(db, "productos", id));
            }
        };

        window.prepararEdicion = (id, nombre, cat, stock, min, precio) => {
            document.getElementById('prodId').value = id;
            document.getElementById('nombre').value = nombre;
            document.getElementById('categoria').value = cat;
            document.getElementById('stock').value = stock;
            document.getElementById('min').value = min;
            document.getElementById('precio').value = precio;
            document.getElementById('formTitle').innerText = "Editando Producto";
            document.getElementById('btnCancelar').style.display = "block";
            window.scrollTo({top: 0, behavior: 'smooth'});
        };

        window.resetForm = () => {
            document.getElementById('prodId').value = "";
            document.getElementById('nombre').value = "";
            document.getElementById('categoria').value = "";
            document.getElementById('stock').value = "";
            document.getElementById('min').value = "";
            document.getElementById('precio').value = "";
            document.getElementById('formTitle').innerText = "Nuevo Producto";
            document.getElementById('btnCancelar').style.display = "none";
        };

        document.getElementById('btnCancelar').onclick = resetForm;
    </script>
</body>
</html>